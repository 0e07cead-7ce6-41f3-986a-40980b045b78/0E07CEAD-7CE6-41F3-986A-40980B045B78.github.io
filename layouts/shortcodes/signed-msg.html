<div class="signed-box" id="signed-box-{{ .Ordinal }}">
    <div class="signed-header">
        <span class="status-icon">â³</span> 
        <span class="status-text">Verifying Signature...</span>
    </div>
    
    <div class="signed-content">
        {{ .Get "msg" }}
    </div>

    <input type="hidden" class="data-msg" value="{{ .Get "msg" }}">
    <input type="hidden" class="data-sig" value="{{ .Get "sig" }}">
    
    <div class="signed-footer">
        ğŸ”‘ Signed by Admin (Key: {{ substr $.Site.Params.site_verify_key 0 8 }}...)
    </div>
</div>

<style>
    /* å®¹å™¨æ¨£å¼ï¼šé§­å®¢çµ‚ç«¯æ©Ÿé¢¨æ ¼ */
    .signed-box {
        border: 1px solid #444;
        background: #0d1117;
        padding: 20px;
        border-radius: 6px;
        margin: 25px 0;
        font-family: 'Courier New', monospace;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* æ¨™é ­ç‹€æ…‹åˆ— */
    .signed-header {
        font-size: 0.85rem;
        color: #8b949e;
        border-bottom: 1px dashed #30363d;
        padding-bottom: 10px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: bold;
        letter-spacing: 0.5px;
    }

    /* è¨Šæ¯å…§å®¹ */
    .signed-content {
        color: #e6edf3;
        line-height: 1.6;
        font-size: 1.05rem;
        white-space: pre-wrap; /* ä¿ç•™æ›è¡Œæ ¼å¼ */
    }

    /* é å°¾è³‡è¨Š */
    .signed-footer {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #21262d;
        font-size: 0.75rem;
        color: #484f58;
        text-align: right;
    }

    /* === é©—è­‰ç‹€æ…‹æ¨£å¼ === */
    
    /* æˆåŠŸ (ç¶ è‰²) */
    .verified-success {
        border-color: #238636; /* GitHub Green */
        background: #0d1117; 
        box-shadow: 0 0 15px rgba(35, 134, 54, 0.15);
    }
    .verified-success .status-text { color: #3fb950; }
    .verified-success .signed-header { border-bottom-color: #238636; }

    /* å¤±æ•— (ç´…è‰²) */
    .verified-fail {
        border-color: #da3633; /* GitHub Red */
        background: #1a0505; 
    }
    .verified-fail .status-text { color: #f85149; }
    .verified-fail .status-icon { filter: grayscale(1) brightness(0.5); }
</style>

<script>
(async function() {
    // 1. å¾ Hugo Config è®€å–å…¨åŸŸå…¬é‘°
    // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ Go Template èªæ³•æ³¨å…¥è®Šæ•¸
    const SITE_PUB_KEY_B64 = "{{ $.Site.Params.site_verify_key }}";

    // å–å¾— DOM å…ƒç´ 
    const container = document.getElementById("signed-box-{{ .Ordinal }}");
    if (!container) return;

    const msg = container.querySelector('.data-msg').value;
    const sigB64 = container.querySelector('.data-sig').value;
    const statusText = container.querySelector('.status-text');
    const statusIcon = container.querySelector('.status-icon');

    // è¼”åŠ©å‡½å¼ï¼šBase64 è½‰ ArrayBuffer
    function b64ToBuf(b64) {
        try {
            const bin = atob(b64);
            const buf = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
            return buf;
        } catch (e) {
            console.error("Base64 Decode Error:", e);
            return null;
        }
    }

    try {
        // 2. æª¢æŸ¥å…¬é‘°æ˜¯å¦å­˜åœ¨
        if (!SITE_PUB_KEY_B64 || SITE_PUB_KEY_B64.trim() === "") {
            throw new Error("Missing Public Key in hugo.yml");
        }

        // 3. æº–å‚™è³‡æ–™
        const enc = new TextEncoder();
        const msgData = enc.encode(msg); // å°‡è¨Šæ¯è½‰ç‚º Bytes
        const sigData = b64ToBuf(sigB64); // å°‡ç°½åè½‰ç‚º Bytes
        const keyData = b64ToBuf(SITE_PUB_KEY_B64); // å°‡å…¬é‘°è½‰ç‚º Bytes

        if (!sigData || !keyData) throw new Error("Invalid Key or Signature format");

        // 4. åŒ¯å…¥å…¬é‘° (Ed25519 Raw Format)
        const cryptoKey = await window.crypto.subtle.importKey(
            "raw", 
            keyData,
            { name: "Ed25519", namedCurve: "Ed25519" },
            true, 
            ["verify"]
        );

        // 5. åŸ·è¡Œé©—è­‰ (Verify)
        const isValid = await window.crypto.subtle.verify(
            "Ed25519",
            cryptoKey,
            sigData,
            msgData
        );

        // 6. æ›´æ–° UI çµæœ
        if (isValid) {
            container.classList.add("verified-success");
            statusIcon.innerText = "âœ…";
            statusText.innerText = "SECURE: Signature Verified (Trusted Source)";
        } else {
            throw new Error("Signature Mismatch");
        }

    } catch (e) {
        console.warn("Verification Failed:", e);
        container.classList.add("verified-fail");
        statusIcon.innerText = "â›”";
        statusText.innerText = "WARNING: Invalid Signature / Tampered Message";
    }
})();
</script>