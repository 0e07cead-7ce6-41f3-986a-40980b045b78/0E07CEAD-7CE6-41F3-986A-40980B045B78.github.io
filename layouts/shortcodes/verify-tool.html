<div class="verify-tool-card">
    <div class="tool-header">
        <h3>ğŸ” äº’å‹•å¼ç°½ç« é©—è­‰ (Interactive Verifier)</h3>
        <p>è«‹è¼¸å…¥è¨Šæ¯èˆ‡ç°½åï¼Œç³»çµ±å°‡ä½¿ç”¨ç«™é•·å…¬é‘° (Ed25519) é€²è¡Œé©—è­‰ã€‚</p>
    </div>

    <div class="input-group">
        <label class="input-label">Signature (Base64)</label>
        <input type="text" id="input-sig" class="hacker-input" placeholder="è²¼ä¸Š Base64 ç°½åå­—ä¸² (ä¾‹å¦‚: G1wkVr...)" autocomplete="off">
    </div>

    <div class="input-group">
        <label class="input-label">Message</label>
        <textarea id="input-msg" class="hacker-input" rows="5" placeholder="è²¼ä¸Šå°æ‡‰çš„åŸå§‹è¨Šæ¯æ–‡å­—..."></textarea>
    </div>

    <!-- âœ… æ–°å¢ï¼šé©—è­‰èªªæ˜å€å¡Š -->
    <div class="verify-notice">
        <div class="notice-title">ğŸ“‹ é©—è­‰èªªæ˜:</div>
        <div class="notice-content">
            æœ¬ç°½åä½¿ç”¨ <strong>Ed25519 æ¼”ç®—æ³•</strong>ï¼Œå°ã€ŒåŸå§‹ UTF-8 æ–‡å­—ã€é€²è¡Œç°½ç½²ã€‚<br>
            é©—è­‰æ™‚è«‹ç¢ºä¿ç•™è¨€å…§å®¹æœªè¢«ä¿®æ”¹ï¼ˆåŒ…å«ç©ºç™½ã€æ›è¡Œã€æ¨™é»ï¼‰ã€‚
        </div>
    </div>

    <div class="action-area">
        <button onclick="verifySignature()" class="verify-btn">Verify Signature</button>
        <div id="verify-result" class="result-display" style="display:none;"></div>
    </div>

    <div class="key-info">
        Using Public Key: {{ substr $.Site.Params.site_verify_key 0 12 }}... (Hardcoded in System)
    </div>
</div>

<style>
    /* æ•´é«”å¡ç‰‡é¢¨æ ¼ */
    .verify-tool-card {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 25px;
        margin: 20px 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .tool-header h3 { margin-top: 0; color: #e6edf3; }
    .tool-header p { color: #8b949e; font-size: 0.9rem; margin-bottom: 20px; }

    /* è¼¸å…¥å€å¡Š */
    .input-group { margin-bottom: 20px; }
    .input-label {
        display: block;
        color: #e6edf3;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .hacker-input {
        width: 100%;
        padding: 10px;
        background-color: #161b22; /* æ·±è‰²èƒŒæ™¯ */
        border: 1px solid #30363d;
        color: #c9d1d9;
        border-radius: 6px;
        font-family: 'Courier New', monospace; /* é§­å®¢å­—é«” */
        font-size: 0.95rem;
        box-sizing: border-box; /* é˜²æ­¢ padding æ’ç ´å¯¬åº¦ */
        transition: border-color 0.2s;
    }
    .hacker-input:focus {
        outline: none;
        border-color: #58a6ff; /* GitHub è— */
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
    }

    /* âœ… æ–°å¢ï¼šé©—è­‰èªªæ˜å€å¡Šæ¨£å¼ */
    .verify-notice {
        background: #161b22;
        border: 1px dashed #30363d;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }
    .notice-title {
        color: #79c0ff;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    .notice-content {
        color: #8b949e;
        line-height: 1.6;
    }
    .notice-content strong {
        color: #c9d1d9;
    }

    /* æŒ‰éˆ• */
    .verify-btn {
        background-color: #238636; /* GitHub ç¶  */
        color: white;
        border: 1px solid rgba(240,246,252,0.1);
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }
    .verify-btn:hover { background-color: #2ea043; }
    .verify-btn:active { background-color: #1f6f30; }

    /* çµæœé¡¯ç¤ºå€ */
    .result-display {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
        font-weight: bold;
        border-left: 5px solid transparent;
    }
    .result-success {
        background: rgba(46, 160, 67, 0.15);
        border-left-color: #238636;
        color: #3fb950;
    }
    .result-fail {
        background: rgba(218, 54, 51, 0.15);
        border-left-color: #da3633;
        color: #f85149;
    }

    .key-info {
        margin-top: 20px;
        font-size: 0.8rem;
        color: #484f58;
        text-align: right;
        font-family: monospace;
    }
</style>

<script>
async function verifySignature() {
    // 1. å–å¾— Hugo è¨­å®šä¸­çš„å…¬é‘°
    const PUB_KEY_B64 = "{{ $.Site.Params.site_verify_key }}";
    
    // å–å¾—ä½¿ç”¨è€…è¼¸å…¥
    const sigInput = document.getElementById('input-sig').value.trim();
    const msgInput = document.getElementById('input-msg').value; // è¨Šæ¯ä¸ trimï¼Œä¿ç•™åŸå§‹æ ¼å¼
    const resultDiv = document.getElementById('verify-result');

    // ç°¡å–®æª¢æŸ¥
    if (!sigInput || !msgInput) {
        showResult(false, "è«‹è¼¸å…¥å®Œæ•´çš„ç°½åèˆ‡è¨Šæ¯ (Missing Input)");
        return;
    }

    try {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = "â³ Verifying...";
        resultDiv.className = "result-display";

        // 2. è½‰æ›è³‡æ–™æ ¼å¼
        const enc = new TextEncoder();
        const msgData = enc.encode(msgInput);
        const sigData = b64ToBuf(sigInput);
        const keyData = b64ToBuf(PUB_KEY_B64);

        if(!sigData) throw new Error("ç„¡æ•ˆçš„ Base64 ç°½åæ ¼å¼");

        // 3. åŒ¯å…¥å…¬é‘°
        const cryptoKey = await window.crypto.subtle.importKey(
            "raw", keyData, { name: "Ed25519", namedCurve: "Ed25519" }, true, ["verify"]
        );

        // 4. é©—è­‰
        const isValid = await window.crypto.subtle.verify(
            "Ed25519", cryptoKey, sigData, msgData
        );

        // 5. é¡¯ç¤ºçµæœ
        if (isValid) {
            showResult(true, "âœ… é©—è­‰æˆåŠŸ (VERIFIED): æ­¤è¨Šæ¯ç¢ºå¯¦ç”±ç«™é•·ç°½ç½²ï¼Œæœªè¢«ç¯¡æ”¹ã€‚");
        } else {
            showResult(false, "â›” é©—è­‰å¤±æ•— (FAILED): ç°½åç„¡æ•ˆï¼Œè¨Šæ¯å¯èƒ½å·²è¢«ç¯¡æ”¹æˆ–éæœ¬äººç™¼é€ã€‚");
        }

    } catch (e) {
        console.error(e);
        showResult(false, "âŒ åŸ·è¡ŒéŒ¯èª¤: " + e.message);
    }
}

function showResult(isSuccess, text) {
    const div = document.getElementById('verify-result');
    div.style.display = 'block';
    div.innerText = text;
    div.className = "result-display " + (isSuccess ? "result-success" : "result-fail");
}

function b64ToBuf(b64) {
    try {
        const bin = atob(b64);
        const buf = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
        return buf;
    } catch (e) { return null; }
}
</script>