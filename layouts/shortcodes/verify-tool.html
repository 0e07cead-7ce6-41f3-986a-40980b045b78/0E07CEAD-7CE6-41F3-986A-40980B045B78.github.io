<div class="verify-tool-card">
    <div class="tool-header">
        <h3>ğŸ” äº’å‹•å¼ç°½ç« é©—è­‰ (Interactive Verifier)</h3>
        <p>è«‹è¼¸å…¥è¨Šæ¯èˆ‡ç°½åï¼Œç³»çµ±å°‡ä½¿ç”¨ç«™é•·å…¬é‘° (Ed25519) é€²è¡Œé©—è­‰ã€‚</p>
    </div>

    <div class="input-group">
        <label class="input-label">Signature (Base64)</label>
        <input type="text" id="input-sig" class="hacker-input" placeholder="è²¼ä¸Š Base64 ç°½åå­—ä¸² (ä¾‹å¦‚: G1wkVr...)" autocomplete="off">
    </div>

    <div class="input-group">
        <label class="input-label">Message</label>
        <textarea id="input-msg" class="hacker-input" rows="5" placeholder="è²¼ä¸Šå°æ‡‰çš„åŸå§‹è¨Šæ¯æ–‡å­—..." oninput="updateMessageHash()"></textarea>
    </div>

    <!-- Message SHA-256 Hash é¡¯ç¤ºå€ -->
    <div class="hash-display-box">
        <div class="hash-label">
            ğŸ” Message SHA-256 Hash <span class="hash-hint">(ç”¨æ–¼é©—è­‰è¨Šæ¯å®Œæ•´æ€§)</span>
        </div>
        <div id="msg-hash-output" class="hash-output">
            <span style="color: #666;">ç­‰å¾…è¼¸å…¥è¨Šæ¯...</span>
        </div>
        <button onclick="copyHash()" class="copy-hash-btn" id="copy-hash-btn" style="display: none;">ğŸ“‹ è¤‡è£½ Hash</button>
    </div>

    <!-- âœ… æ–°å¢ï¼šç«™é•·åŸå§‹ Message Hash è¼¸å…¥èˆ‡æ¯”å°å€ -->
    <div class="compare-hash-box">
        <div class="compare-label">
            ğŸ¯ ç«™é•·åŸå§‹ Message çš„ SHA-256 <span class="hash-hint">(è²¼ä¸Šä»¥é€²è¡Œæ¯”å°)</span>
        </div>
        <input type="text" id="admin-hash-input" class="hash-input" placeholder="è²¼ä¸Šç«™é•·å…¬å¸ƒçš„ SHA-256 Hash..." oninput="compareHashes()" autocomplete="off">
        <div id="compare-result" class="compare-result" style="display: none;"></div>
    </div>

    <!-- é©—è­‰èªªæ˜å€å¡Š -->
    <div class="verify-notice">
        <div class="notice-title">ğŸ“‹ é©—è­‰èªªæ˜:</div>
        <div class="notice-content">
            æœ¬ç°½åä½¿ç”¨ <strong>Ed25519 æ¼”ç®—æ³•</strong>ï¼Œå°ã€ŒåŸå§‹ UTF-8 æ–‡å­—ã€é€²è¡Œç°½ç½²ã€‚<br>
            é©—è­‰æ™‚è«‹ç¢ºä¿ç•™è¨€å…§å®¹æœªè¢«ä¿®æ”¹ï¼ˆåŒ…å«ç©ºç™½ã€æ›è¡Œã€æ¨™é»ï¼‰ã€‚
        </div>
    </div>

    <div class="action-area">
        <button onclick="verifySignature()" class="verify-btn">Verify Signature</button>
        <div id="verify-result" class="result-display" style="display:none;"></div>
    </div>

    <div class="key-info">
        Using Public Key: {{ substr $.Site.Params.site_verify_key 0 12 }}... (Hardcoded in System)
    </div>
</div>

<style>
    /* æ•´é«”å¡ç‰‡é¢¨æ ¼ */
    .verify-tool-card {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 25px;
        margin: 20px 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .tool-header h3 { margin-top: 0; color: #e6edf3; }
    .tool-header p { color: #8b949e; font-size: 0.9rem; margin-bottom: 20px; }

    /* è¼¸å…¥å€å¡Š */
    .input-group { margin-bottom: 20px; }
    .input-label {
        display: block;
        color: #e6edf3;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .hacker-input {
        width: 100%;
        padding: 10px;
        background-color: #161b22;
        border: 1px solid #30363d;
        color: #c9d1d9;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        box-sizing: border-box;
        transition: border-color 0.2s;
    }
    .hacker-input:focus {
        outline: none;
        border-color: #58a6ff;
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
    }

    /* Hash é¡¯ç¤ºå€å¡Š */
    .hash-display-box {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .hash-label {
        color: #79c0ff;
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .hash-hint {
        color: #8b949e;
        font-weight: normal;
        font-size: 0.85rem;
    }
    .hash-output {
        background: #010409;
        border: 1px solid #21262d;
        border-radius: 4px;
        padding: 12px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: #7ee787;
        word-break: break-all;
        line-height: 1.5;
        min-height: 40px;
        display: flex;
        align-items: center;
    }
    .copy-hash-btn {
        margin-top: 10px;
        background: transparent;
        border: 1px solid #30363d;
        color: #8b949e;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: 0.2s;
    }
    .copy-hash-btn:hover {
        border-color: #58a6ff;
        color: #58a6ff;
    }

    /* âœ… æ–°å¢ï¼šHash æ¯”å°å€å¡Š */
    .compare-hash-box {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .compare-label {
        color: #d2a8ff;
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .hash-input {
        width: 100%;
        padding: 10px;
        background: #010409;
        border: 1px solid #21262d;
        color: #c9d1d9;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        box-sizing: border-box;
        transition: border-color 0.2s;
    }
    .hash-input:focus {
        outline: none;
        border-color: #d2a8ff;
        box-shadow: 0 0 0 3px rgba(210, 168, 255, 0.1);
    }
    .compare-result {
        margin-top: 12px;
        padding: 12px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.9rem;
        border-left: 4px solid transparent;
    }
    .compare-match {
        background: rgba(46, 160, 67, 0.15);
        border-left-color: #238636;
        color: #3fb950;
    }
    .compare-mismatch {
        background: rgba(218, 54, 51, 0.15);
        border-left-color: #da3633;
        color: #f85149;
    }

    /* é©—è­‰èªªæ˜å€å¡Š */
    .verify-notice {
        background: #161b22;
        border: 1px dashed #30363d;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }
    .notice-title {
        color: #79c0ff;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    .notice-content {
        color: #8b949e;
        line-height: 1.6;
    }
    .notice-content strong {
        color: #c9d1d9;
    }

    /* æŒ‰éˆ• */
    .verify-btn {
        background-color: #238636;
        color: white;
        border: 1px solid rgba(240,246,252,0.1);
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
    }
    .verify-btn:hover { background-color: #2ea043; }
    .verify-btn:active { background-color: #1f6f30; }

    /* çµæœé¡¯ç¤ºå€ */
    .result-display {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
        font-weight: bold;
        border-left: 5px solid transparent;
    }
    .result-success {
        background: rgba(46, 160, 67, 0.15);
        border-left-color: #238636;
        color: #3fb950;
    }
    .result-fail {
        background: rgba(218, 54, 51, 0.15);
        border-left-color: #da3633;
        color: #f85149;
    }

    .key-info {
        margin-top: 20px;
        font-size: 0.8rem;
        color: #484f58;
        text-align: right;
        font-family: monospace;
    }
</style>

<script>
// å³æ™‚è¨ˆç®— Message çš„ SHA-256
async function updateMessageHash() {
    const msgInput = document.getElementById('input-msg').value;
    const hashOutput = document.getElementById('msg-hash-output');
    const copyBtn = document.getElementById('copy-hash-btn');

    if (!msgInput) {
        hashOutput.innerHTML = '<span style="color: #666;">ç­‰å¾…è¼¸å…¥è¨Šæ¯...</span>';
        copyBtn.style.display = 'none';
        // æ¸…ç©ºæ¯”å°çµæœ
        document.getElementById('compare-result').style.display = 'none';
        return;
    }

    try {
        // è¨ˆç®— SHA-256
        const msgBuffer = new TextEncoder().encode(msgInput);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        // é¡¯ç¤ºçµæœ
        hashOutput.innerText = hashHex;
        copyBtn.style.display = 'inline-block';

        // è‡ªå‹•è§¸ç™¼æ¯”å°
        compareHashes();
    } catch (e) {
        hashOutput.innerHTML = '<span style="color: #ff4444;">è¨ˆç®—éŒ¯èª¤</span>';
        copyBtn.style.display = 'none';
    }
}

// âœ… æ–°å¢ï¼šæ¯”å°å…©å€‹ Hash æ˜¯å¦ç›¸åŒ
function compareHashes() {
    const userHash = document.getElementById('msg-hash-output').innerText.trim();
    const adminHash = document.getElementById('admin-hash-input').value.trim().toLowerCase();
    const resultDiv = document.getElementById('compare-result');

    // å¦‚æœä»»ä¸€æ¬„ä½ç‚ºç©ºï¼Œéš±è—çµæœ
    if (!userHash || userHash === 'ç­‰å¾…è¼¸å…¥è¨Šæ¯...' || !adminHash) {
        resultDiv.style.display = 'none';
        return;
    }

    // æ¯”å° Hash
    if (userHash.toLowerCase() === adminHash) {
        resultDiv.className = 'compare-result compare-match';
        resultDiv.innerHTML = 'âœ… <strong>Hash ç›¸ç¬¦ï¼</strong> è¨Šæ¯å…§å®¹èˆ‡ç«™é•·åŸå§‹æ–‡å­—å®Œå…¨ä¸€è‡´ã€‚';
    } else {
        resultDiv.className = 'compare-result compare-mismatch';
        resultDiv.innerHTML = 'âŒ <strong>Hash ä¸ç¬¦ï¼</strong> è¨Šæ¯å¯èƒ½æœ‰èª¤ï¼ˆæª¢æŸ¥ç©ºæ ¼ã€æ›è¡Œã€æ¨™é»ç¬¦è™Ÿï¼‰ã€‚';
    }
    resultDiv.style.display = 'block';
}

// è¤‡è£½ Hash åŠŸèƒ½
function copyHash() {
    const hashText = document.getElementById('msg-hash-output').innerText;
    navigator.clipboard.writeText(hashText).then(() => {
        const btn = document.getElementById('copy-hash-btn');
        const originalText = btn.innerText;
        btn.innerText = "âœ… å·²è¤‡è£½ï¼";
        setTimeout(() => btn.innerText = originalText, 1500);
    });
}

async function verifySignature() {
    // 1. å–å¾— Hugo è¨­å®šä¸­çš„å…¬é‘°
    const PUB_KEY_B64 = "{{ $.Site.Params.site_verify_key }}";
    
    // å–å¾—ä½¿ç”¨è€…è¼¸å…¥
    const sigInput = document.getElementById('input-sig').value.trim();
    const msgInput = document.getElementById('input-msg').value; // è¨Šæ¯ä¸ trimï¼Œä¿ç•™åŸå§‹æ ¼å¼
    const resultDiv = document.getElementById('verify-result');

    // ç°¡å–®æª¢æŸ¥
    if (!sigInput || !msgInput) {
        showResult(false, "è«‹è¼¸å…¥å®Œæ•´çš„ç°½åèˆ‡è¨Šæ¯ (Missing Input)");
        return;
    }

    try {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = "â³ Verifying...";
        resultDiv.className = "result-display";

        // 2. è½‰æ›è³‡æ–™æ ¼å¼
        const enc = new TextEncoder();
        const msgData = enc.encode(msgInput);
        const sigData = b64ToBuf(sigInput);
        const keyData = b64ToBuf(PUB_KEY_B64);

        if(!sigData) throw new Error("ç„¡æ•ˆçš„ Base64 ç°½åæ ¼å¼");

        // 3. åŒ¯å…¥å…¬é‘°
        const cryptoKey = await window.crypto.subtle.importKey(
            "raw", keyData, { name: "Ed25519", namedCurve: "Ed25519" }, true, ["verify"]
        );

        // 4. é©—è­‰
        const isValid = await window.crypto.subtle.verify(
            "Ed25519", cryptoKey, sigData, msgData
        );

        // 5. é¡¯ç¤ºçµæœ
        if (isValid) {
            showResult(true, "âœ… é©—è­‰æˆåŠŸ (VERIFIED): æ­¤è¨Šæ¯ç¢ºå¯¦ç”±ç«™é•·ç°½ç½²ï¼Œæœªè¢«ç¯¡æ”¹ã€‚");
        } else {
            showResult(false, "â›” é©—è­‰å¤±æ•— (FAILED): ç°½åç„¡æ•ˆï¼Œè¨Šæ¯å¯èƒ½å·²è¢«ç¯¡æ”¹æˆ–éæœ¬äººç™¼é€ã€‚");
        }

    } catch (e) {
        console.error(e);
        showResult(false, "âŒ åŸ·è¡ŒéŒ¯èª¤: " + e.message);
    }
}

function showResult(isSuccess, text) {
    const div = document.getElementById('verify-result');
    div.style.display = 'block';
    div.innerText = text;
    div.className = "result-display " + (isSuccess ? "result-success" : "result-fail");
}

function b64ToBuf(b64) {
    try {
        const bin = atob(b64);
        const buf = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
        return buf;
    } catch (e) { return null; }
}
</script>